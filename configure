#!/bin/sh

# Basic environment variables
[ -z ${MAKE+x} ] && MAKE="make"
[ -z ${CXX+x} ]  && CXX="c++"
[ -z ${QMAKE+x} ]    && QMAKE="$(which qmake-qt5 2>/dev/null || which qmake 2>/dev/null)"
[ -z ${LRELEASE+x} ] && LRELEASE="$(which lrelease-qt5 2>/dev/null || which lrelease 2>/dev/null)"

help() {
cat << EOF

Usage: ./configure [OPTION]... [VAR=VALUE]...

To assign environment variables (e.g. CFLAGS...), specify them as
VAR=VALUE.  See below for descriptions of some of the useful variables.

Defaults for the options are specified in brackets.

  -h, --help              display this help and exit

  --prefix PREFIX,
  --prefix=PREFIX         install files in PREFIX [/usr/local]

  -d, --debug             build with debugging symbols intact

  --fail-on-missing       return exit 1 if non-optional components are missing

  --lrelease COMMAND,
  --lrelease=COMMAND      specify lrelease command [$LRELEASE]

  --qmake COMMAND,
  --qmake=COMMAND         specify qmake command [$QMAKE]
  --qmake-args ARGS       arguments to pass directly to qmake

Some influential environment variables:
  MAKE        make command
  CXX         C++ compiler
  LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
              nonstandard directory <lib dir>
  CPPFLAGS    (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if
              you have headers in a nonstandard directory <include dir>
  CXXFLAGS    C++ compiler flags

EOF
}

# Functions

# nqq_check_binary(string displayName, string binaryName, bool quitOnError, string extError)
# Checks for a given binary file using which
nqq_check_binary() {
    fail_message="not found!"
    [ -z ${4+x} ] || fail_message="${fail_message} ${4}"
    printf "checking for $1... "
    t=$(basename $2)
    which $t 2>/dev/null || nqq_config_error "$fail_message" $3
}

# nqq_check_library(string libraryName)
# Uses pkg-config to check for a given library, exits on failure
nqq_check_library() {
    which pkg-config >/dev/null 2>&1 || return
    for l in $@; do
        printf "checking for ${l} library... "
        pkg-config --libs $l 2>/dev/null || nqq_config_error "not found!" 1
    done
}
# nqq_compile_test
# Compiles a test C++ program using the c++14 standard
# Exits script on failure
nqq_compile_test() {
    TESTOUT="$(mktemp)"
    TESTPROG="#include <iostream>\nint main(){std::cout << \"test\" << std::endl ;return 0;}"

    printf "checking whether c++ compiler builds test program with c++14... "
    if printf "$TESTPROG" | $CXX -xc++ -std=c++14 -o "$TESTOUT" -;then
        echo "ok"
    else
        nqq_config_error "error!" 1
    fi

    printf "checking whether compiled test program works... "
    $TESTOUT >/dev/null 2>&1 && echo "ok" || nqq_config_error "error!" 1
}

# nqq_config_error(string errorMessage, bool quitOnError)
# Prints a config error, optionally exiting the script if 1 is passed
nqq_config_error() {
    printf "$1\n"
    [ "$2" -eq 1 ] && exit 1
    [ "$fail_on_missing" -eq 1 ] || exit 1
}

# Parse command line arguments
fail_on_missing=""
while [ $# -gt 0 ]; do
    key="$1"
    shift
    case $key in
        -h|--help) help;exit 0;;
        -d|--debug) BUILDMODE="debug"; echo "WARNING: Building in debug mode!";;
        --prefix=*) PREFIX="${key#*=}";;
        --prefix)   PREFIX="$1";shift;;
        --fail-on-missing) fail_on_missing=1;;
        --lrelease=*) LRELEASE="${key#*=}";;
        --lrelease)LRELEASE="$1";shift;;
        --qmake=*)QMAKE="${key#*=}";;
        --qmake)QMAKE="$1";shift;;
        --qmake-args)break;;
        *)echo WARNING: Unknown option "$key";;
    esac
done

# Run tests
nqq_check_binary "QT5 qmake" "$QMAKE" 1 "
Try running configure with '--qmake /path/to/qmake'."
nqq_check_binary lrelease "$LRELEASE" 1 "
Try running configure with '--lrelease /path/to/lrelease'."
nqq_check_binary c++ "$CXX" 1
nqq_compile_test
nqq_check_binary make "$MAKE" 1
nqq_check_binary pkg-config pkg-config
nqq_check_library uchardet 
nqq_check_library Qt5Core Qt5Gui Qt5Network Qt5WebEngine Qt5Widgets Qt5WebEngineWidgets Qt5PrintSupport Qt5Svg Qt5WebSockets Qt5WebChannel

[ -f "Makefile" ] && make distclean >/dev/null 2>&1 || true
printf "generate Makefile... "

[ -z ${CPPFLAGS+x} ] || CXXFLAGS="${CXXFLAGS} ${CPPFLAGS}"
QT_SELECT=qt5 $QMAKE PREFIX="$PREFIX" \
QMAKE_CXX="$CXX" \
QMAKE_CXXFLAGS="$CXXFLAGS" \
QMAKE_LFLAGS="$LDFLAGS" \
LRELEASE="$LRELEASE" \
CONFIG+="$BUILDMODE" \
"$@" notepadqq.pro && echo "done" || nqq_config_error "error!" 1
